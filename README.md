# DIY маршрутизатор
## шаг 1: ### Создание виртуального маршрутизатора
### подготовка
сначала нам нужно скачать iso-файл debian 13 и vb c сайтов:
-  [https://www.debian.org/download](https://www.debian.org/download)
-  [https://www.oracle.com/virtualization/technologies/vm/downloads/virtualbox-downloads.html?source=:ow:o:p:nav:mmddyyVirtualBoxHero&intcmp=:ow:o:p:nav:mmddyyVirtualBoxHero](https://www.oracle.com/virtualization/technologies/vm/downloads/virtualbox-downloads.html?source=:ow:o:p:nav:mmddyyVirtualBoxHero&intcmp=:ow:o:p:nav:mmddyyVirtualBoxHero)
после этого установите vb в удобное место и запустите.
далее сделайте следующие шаги для создания первой машины в вб, которая будет маршрутизатором:
1. ![my](картинки/1.png)
2. ![my](картинки/2.png)
3. установите ресурсов пк вы готовы выделить для машины![my](картинки/3.png)
4. ![my](картинки/4.png)
5. нажмите кнопку "готово".

### шаг 2: установка и настройка маршрутизатора
1. откройте настройки созданой машины
2. откройте раздел "носители"
3. нажмите на "пусто"
4. нажмите на значек жесткого диска справа![my](картинки/5.png)
5. нажмите "выбрать файл диска", перейдите в место куда установился файл и выберите его
6. запустите машину
7. выберите графическую установку
8. выберите язык
9. имя компьютера - march
   имя домена пропустите(ничего не вписывайте)
   пароль для суперпользователя выберите любой
   имя второго пользователя без супер-прав - user
   имя пользователя под которым вы будете известным в системе оставьте таким же
   напишите пароль для второго пользователя
10. выберите "авто - использовать весь диск"
11. выберите предложенный диск
12. выберите "все файлы в одном месте"
13. выберите "Закончить разметку и записать изменения на диск"
14. записать изменения на диск: да
15. просканировать дополнительные установочные устройства: нет
16. выберите "российская федерация"
17. выберите "deb.debian.com"
18. информация о http-прокси пропустите(ничего не вписывайте)
19. участвовать в опросе популярности пакетов: как хотите
20. при выборе программного обеспечения выберите только ssh-сервер и стандартные системные утилиты
21. установить системный загрузчик grub на первичный диск: нет
22. устройство для установки системного загрузчика: выберите тот, который уже существует.
23. ждите пока машины запустится а затем выключите ее(нажмите на "машина" сверху, а потом "завершить работу")



после установки машина должна сама завестить. входим в систему и выполняем `apt update` и `apt install systemd-resolved` чтобы установить недостающий пакет.
после этого выключаем машину и выполняем действия:
1. откройте настройки машины 
2. перейдите в раздел "сеть"
3. включите первый адаптер
   тип подключения "сетевой мост"
   таким образом мы создадим виртуальную сетевую карту для устройства и оно станет таким же полноправной часть сети как и ваш компьютер
4. включите второй адаптер
   выберите тип подключения - внутренняя сеть
   таким образом мы создали виртуальную локальную сеть в виртуальной среде в которой будет находиться наши клиенты
5. выключите все другие адаптеры если они включены

существует два сервиса для настройки сети ifupdown и systemd-network.
мы будем использовать только второй вариант так как он более современный.

## Шаг 2: Настройка сетевых интерфейсов Маршрутизатора
### настройка WAN интерфейса
1. отключим конфликтующий сервис при помощи `systemctl stop networking` и `systemctl mask networking`
2. `nano /etc/systemd/network/20-wan.network`
3. в открывшемся окне пишем:
   `[Match]`
   `Name=enp0s3`
   `[Network]`
   `DHCP=yes`
   таким образом мы настроили WAN. теперь он выполняет функцию DHCP-сервера, а ip адрес назначается автоматически
4. нажмите `Ctrl+X` затем `Y`,ентер чтобы сохранить и выйти
### настройка LAN интерфейса
1. `nano /etc/systemd/network/10-lan.network`
2. в открывшемся окне пишем:
   `[Match]`
   `Name=enp0s8`
   `[Network]`
   `Address=192.168.50.1/24`
   таким образом мы настроили LAN. мы указали самостоятельно какой у него будет ip
3. сохраняем и выходим из этого окна

### настройка  DNS и запуска сервисов
1. Удаляем старый файл DNS
   `rm /etc/resolv.conf`
2. Создаем ссылку на новый системный файл DNS
   `ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf`
3. Включаем и запускаем сервис сети
   `systemctl enable --now systemd-networkd`
4. Включаем и запускаем сервис DNS
   `systemctl enable --now systemd-resolved`

### проверка сетевых настроек
теперь для проверки вводим команду `networkctl status`. Вы должны увидеть список интерфейсов со статусом `configured` или `routable` (зеленым цветом).
Проверьте IP-адреса и выполните `ip a`
Убедитесь, что:
- `enp0s3`имеет адрес от провайдера (например, 192.168.1.x или 10.x.x.x).
- `enp0s8`имеет адрес`192.168.50.1`
## шаг 3: Включение маршрутизации и NAT
### Включение пересылки пакетов
Нужно разрешить ядру Linux перекладывать пакеты с одного интерфейса на другой.
1. открываем файл системных настроек:
   `nano /etc/sysctl.conf`
2. нужно найти строчку `#net.ipv4.ip_forward=1` и удалить символ "#"
   если когда вы выполнили `nano /etc/sysctl.conf` у вас создался новый файл, то ничего страшного. просто введите туда `net.ipv4.ip_forward=1`
3. Примените изменения без перезагрузки:
   `sysctl -p`
4. _Если в ответ вывелась строчка `net.ipv4.ip_forward = 1`, значит всё сработало._

### Установка и настройка NFTables (NAT)
Теперь настроим маскировку (NAT). Это заставит роутер подменять адреса пакетов, исходящих от юзеров, на свой собственный внешний адрес.

1. Установите пакет (обычно он есть, но проверим):
	```
	apt update && apt install nftables
	```

2. Откройте файл конфигурации фаервола. Внимание: мы полностью заменим его содержимое на нашу простую конфигурацию.
	```
	nano /etc/nftables.conf
	```

3. Удалите всё, что там есть (можно зажать`Ctrl+K`, чтобы удалять строки), и вставьте следующий текст. **Важно:** В строке`oifname`укажите имя вашего **WAN** интерфейса (тот, что смотрит в интернет, например`enp0s3`).
   ```
   #!/usr/sbin/nft -f
   
   flush ruleset
   
   table ip nat {
	   chain postrouting {
		   type nat hook postrouting priority 100;
		   oifname "enp0s3" masquerade
		}
	}
	```
	_Разбор:_ Мы создали таблицу `nat`, цепочку `postrouting` (после маршрутизации) и правило: "всё, что уходит через интерфейс `enp0s3`, маскировать".

### Запуск фаервола
  1. Включите автозагрузку и запустите службу:
  ```
  systemctl enable --now nftables
  ```

2. Проверьте, что правила загрузились:
 ```
 nft list ruleset
 ```
Вы должны увидеть ту конфигурацию, которую только что написали.
### Итог этапа 3
Теперь ваш Debian официально стал маршрутизатором.
- Он умеет пересылать пакеты (`ip_forward`).
- Он умеет притворяться, что все запросы идут от него (`masquerade`).
